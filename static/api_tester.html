<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الـ API Endpoints</title>
    <meta name="description" content="اختبر جميع واجهات برمجة التطبيقات (API) بسهولة واحترافية مع جلب معلمات حقيقية من الداشبورد.">
    <link rel="stylesheet" href="/static/dashboard_style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { padding-top: 80px !important; }
        .navbar { background: linear-gradient(90deg, #1976d2 0%, #0d47a1 100%); color: #fff; padding: 0; display: flex; align-items: center; justify-content: space-between; height: 68px; box-shadow: 0 4px 18px rgba(30,60,120,0.13); border-radius: 0 0 18px 18px; position: fixed; top: 0; left: 0; width: 100vw; z-index: 100; }
        .navbar .brand { font-size: 1.6em; font-weight: bold; padding: 0 40px; display: flex; align-items: center; gap: 12px; letter-spacing: 1px; }
        .navbar .brand .icon { font-size: 2em; margin-left: 8px; filter: drop-shadow(0 2px 4px #0d47a1aa); }
        .navbar .menu { display: flex; align-items: center; gap: 12px; padding: 0 32px; }
        .navbar .menu button { background: rgba(255,255,255,0.13); color: #fff; border: none; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; cursor: pointer; transition: background 0.2s, transform 0.2s; box-shadow: 0 2px 8px rgba(30,60,120,0.10); }
        .navbar .menu button:hover { background: #fff; color: #1976d2; transform: translateY(-2px) scale(1.08); }
        .api-tester { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 6px 32px rgba(30,60,120,0.10); padding: 36px 28px; }
        h2 { color: #0d47a1; text-align: center; }
        .endpoint-row { display: flex; gap: 12px; align-items: center; margin-bottom: 18px; }
        .endpoint-row select, .endpoint-row input, .endpoint-row textarea { font-family: inherit; font-size: 1em; border-radius: 6px; border: 1px solid #bdbdbd; padding: 7px 10px; }
        .endpoint-row select, .endpoint-row input { min-width: 120px; }
        .endpoint-row input[type=text] { width: 220px; }
        .endpoint-row textarea { width: 320px; min-height: 36px; }
        .endpoint-row button { background: #1976d2; color: #fff; border: none; border-radius: 6px; padding: 8px 20px; font-size: 1em; cursor: pointer; margin-right: 8px; }
        .endpoint-row button:hover { background: #0d47a1; }
        .api-result { background: #f7fafd; border-radius: 10px; padding: 18px; margin-top: 18px; font-size: 0.98em; direction: ltr; text-align: left; overflow-x: auto; }
        .api-result-fixed {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f7fafd;
            border-top: 2px solid #1976d2;
            border-radius: 18px 18px 0 0;
            box-shadow: 0 -2px 12px rgba(30,60,120,0.10);
            padding: 18px 24px;
            min-height: 120px;
            max-height: 40vh;
            overflow-y: auto;
            font-size: 0.98em;
            direction: ltr;
            text-align: left;
            z-index: 200;
            resize: vertical;
        }
        .param-btn { background: #ff9800; color: #fff; border: none; border-radius: 6px; padding: 4px 10px; font-size: 0.95em; cursor: pointer; margin-right: 6px; }
        .param-btn:hover { background: #e65100; }
        @media (max-width: 700px) { .api-tester { padding: 10px 2px; } .endpoint-row { flex-direction: column; align-items: stretch; } .endpoint-row input, .endpoint-row textarea, .endpoint-row select { width: 100% !important; min-width: 0; } }
    </style>
</head>
<body>
    <div class="navbar">
        <span class="brand"><span class="icon">🧪</span> اختبار الـ API</span>
        <div class="menu">
            <button title="الرئيسية" onclick="window.location.href='/apps-dashboard/'"><span>🏠</span></button>
            <button title="خروج" onclick="logout()" style="background:#b71c1c;"><span>🔓</span></button>
        </div>
    </div>
    <div class="api-tester">
        <h2>اختبار جميع الـ Endpoints بسهولة</h2>
        <div id="allEndpointsFlat" style="margin-bottom:40px;"></div>
        <div id="dynamicForm"></div>
        <div id="sectionTitle" style="font-size:1.15em;color:#0d47a1;font-weight:bold;margin-bottom:10px;display:none;"></div>
        <button id="showEndpointsBtn" style="margin:18px auto 0 auto;display:block;background:#1976d2;color:#fff;border:none;border-radius:8px;padding:10px 32px;font-size:1.1em;cursor:pointer;">عرض جميع الاندبوينتات</button>
        <!-- عناصر مخفية مطلوبة للمنطق -->
        <input type="hidden" id="endpoint">
        <input type="hidden" id="method">
        <input type="hidden" id="urlList">
        <input type="hidden" id="body">
        <span id="finalUrl" style="display:none;"></span>
    </div>
    <script>
        let lastProducts = [];
        let lastCategories = [];
        let lastShops = [];
        let lastUsers = [];
        async function fetchDashboardData() {
            const token = localStorage.getItem('access_token');
            try {
                const [productsRes, catsRes, shopsRes, usersRes] = await Promise.all([
                    fetch('/api/products/', { headers: { 'Authorization': 'Bearer ' + token } }),
                    fetch('/api/categories/', { headers: { 'Authorization': 'Bearer ' + token } }),
                    fetch('/api/shop/', { headers: { 'Authorization': 'Bearer ' + token } }),
                    fetch('/api/auth/users/', { headers: { 'Authorization': 'Bearer ' + token } })
                ]);
                lastProducts = productsRes.ok ? await productsRes.json() : [];
                lastCategories = catsRes.ok ? await catsRes.json() : [];
                lastShops = shopsRes.ok ? await shopsRes.json() : [];
                lastUsers = usersRes.ok ? await usersRes.json() : [];
            } catch (e) { }
        }
        fetchDashboardData();
        function insertParam(type) {
            let val = '';
            if(type==='id' && lastProducts.length) val = lastProducts[0].id;
            if(type==='catid' && lastCategories.length) val = lastCategories[0].id;
            if(type==='shopid' && lastShops.length) val = lastShops[0].id;
            if(type==='userid' && lastUsers.length) val = lastUsers[0].id;
            if(val) {
                const inp = document.getElementById('endpoint');
                let endpoint = inp.value;
                // استبدال أول مكان متوقع للمعرف
                if(type==='id') endpoint = endpoint.replace('{id}', val);
                if(type==='catid') endpoint = endpoint.replace('{catid}', val);
                if(type==='shopid') endpoint = endpoint.replace('{shopid}', val);
                if(type==='userid') endpoint = endpoint.replace('{userid}', val);
                inp.value = endpoint;
                updateFinalUrl();
            }
        }
        // كشف الحقول المطلوبة تلقائياً من القائمة
        document.getElementById('urlList').addEventListener('change', async function() {
            const val = this.value;
            // قائمة endpoints التي تحتاج body مع الحقول المطلوبة
            const endpointsWithBody = {
                '/api/products/': ['name', 'price', 'category', 'brand'],
                '/api/products/{id}/update/': ['name', 'price', 'category', 'brand'],
                '/api/categories/': ['name', 'description'],
                '/api/categories/{catid}/update/': ['name', 'description'],
                '/api/brands/': ['name', 'popularity', 'rating'],
                '/api/brands/{id}/update/': ['name', 'popularity', 'rating'],
                '/api/shop/': ['name', 'owner', 'address'],
                '/api/shop/{shopid}/update/': ['name', 'owner', 'address'],
                '/api/auth/users/': ['username', 'email', 'password'],
                '/api/auth/users/{userid}/update/': ['username', 'email'],
                '/api/promotions/': ['title', 'discount'],
                '/api/promotions/{id}/update/': ['title', 'discount']
            };
            let fields = endpointsWithBody[val] || [];
            const formDiv = document.getElementById('dynamicForm');
            formDiv.innerHTML = '';
            let oldData = {};
            // إذا كان endpoint فيه معرف، جلب البيانات القديمة تلقائياً
            let match = val.match(/\{(id|catid|shopid|userid)\}/);
            if(match) {
                let type = match[1];
                let id = '';
                if(type==='id' && lastProducts.length) id = lastProducts[0].id;
                if(type==='catid' && lastCategories.length) id = lastCategories[0].id;
                if(type==='shopid' && lastShops.length) id = lastShops[0].id;
                if(type==='userid' && lastUsers.length) id = lastUsers[0].id;
                if(id) {
                    // استخراج رابط التفاصيل وليس رابط التحديث
                    let url = val.replace('/update/','').replace('/delete/','').replace(`{${type}}`, id);
                    const token = localStorage.getItem('access_token');
                    try {
                        let res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
                        if(res.ok) oldData = await res.json();
                    } catch(e){}
                }
            }
            if(fields.length) {
                fields.forEach(f => {
                    let v = '';
                    // دعم القيم المتداخلة مثل category.name أو brand.name
                    if(oldData && oldData[f] !== undefined) v = oldData[f];
                    else if(f.includes('.') && oldData) {
                        try {
                            v = f.split('.').reduce((a,b)=>a&&a[b]?a[b]:null, oldData) || '';
                        } catch(e){}
                    }
                    formDiv.innerHTML += `<div style='margin-bottom:8px;'><label style='color:#1976d2;'>${f}</label><input type='text' id='dyn_${f}' value='${v}' style='width:220px;padding:6px 10px;border-radius:6px;border:1px solid #bdbdbd;'></div>`;
                });
                formDiv.style.display = 'block';
            } else {
                formDiv.style.display = 'none';
            }
        });
        // عند الإرسال: إذا كان هناك فورم ديناميكي، اجمع القيم وضعها في body كـ JSON
        async function sendRequest() {
            const method = document.getElementById('method').value;
            let endpoint = document.getElementById('endpoint').value.trim();
            let body = document.getElementById('body').value.trim();
            const token = localStorage.getItem('access_token');
            // جمع القيم من الفورم الديناميكي إذا كان ظاهر
            const formDiv = document.getElementById('dynamicForm');
            if(formDiv && formDiv.style.display !== 'none' && formDiv.children.length) {
                let obj = {};
                Array.from(formDiv.querySelectorAll('input')).forEach(inp => {
                    obj[inp.id.replace('dyn_','')] = inp.value;
                });
                body = JSON.stringify(obj);
                document.getElementById('body').value = body;
            }
            let options = { method, headers: { 'Authorization': 'Bearer ' + token } };
            if(['POST','PUT','PATCH'].includes(method) && body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = body;
            }
            let res, data, text;
            try {
                res = await fetch(endpoint, options);
                text = await res.text();
                try { data = JSON.parse(text); } catch { data = text; }
                document.getElementById('apiResult').style.display = 'block';
                document.getElementById('apiResult').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById('apiResult').style.display = 'block';
                document.getElementById('apiResult').textContent = 'خطأ في الاتصال أو في الرابط.';
            }
        }
        function updateFinalUrl() {
            const endpoint = document.getElementById('endpoint').value;
            document.getElementById('finalUrl').textContent = endpoint;
        }
        document.getElementById('endpoint').addEventListener('input', updateFinalUrl);
        document.getElementById('urlList').addEventListener('change', updateFinalUrl);
        updateFinalUrl();
        function logout() {
            localStorage.removeItem('dashboard_logged_in');
            localStorage.removeItem('dashboard_email');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/static/login.html';
        }
        // تعريف جميع الاندبوينتات مع التصنيف (يجب أن يكون قبل أي استخدام)
        const endpointsBySection = {
            'المنتجات': [
                {url:'/api/products/', label:'جلب كل المنتجات', method:'GET'},
                {url:'/api/products/{id}/', label:'تفاصيل منتج', method:'GET'},
                {url:'/api/products/{id}/update/', label:'تحديث منتج', method:'PUT'},
                {url:'/api/products/{id}/delete/', label:'حذف منتج', method:'DELETE'},
                {url:'/api/products/{id}/reviews-stats/', label:'إحصائيات مراجعات منتج', method:'GET'},
                {url:'/api/products/{id}/reactions/', label:'تفاعلات منتج', method:'GET'},
                {url:'/api/products/{id}/inventory/', label:'مخزون منتج', method:'GET'}
            ],
            'التصنيفات': [
                {url:'/api/categories/', label:'جلب كل التصنيفات', method:'GET'},
                {url:'/api/categories/{catid}/', label:'تفاصيل تصنيف', method:'GET'},
                {url:'/api/categories/{catid}/update/', label:'تحديث تصنيف', method:'PUT'},
                {url:'/api/categories/{catid}/delete/', label:'حذف تصنيف', method:'DELETE'}
            ],
            'العلامات التجارية': [
                {url:'/api/brands/', label:'جلب كل العلامات التجارية', method:'GET'},
                {url:'/api/brands/{id}/', label:'تفاصيل علامة تجارية', method:'GET'},
                {url:'/api/brands/{id}/update/', label:'تحديث علامة تجارية', method:'PUT'},
                {url:'/api/brands/{id}/delete/', label:'حذف علامة تجارية', method:'DELETE'}
            ],
            'المتاجر': [
                {url:'/api/shop/', label:'جلب كل المتاجر', method:'GET'},
                {url:'/api/shop/{shopid}/', label:'تفاصيل متجر', method:'GET'},
                {url:'/api/shop/{shopid}/update/', label:'تحديث متجر', method:'PUT'},
                {url:'/api/shop/{shopid}/delete/', label:'حذف متجر', method:'DELETE'}
            ],
            'المستخدمون': [
                {url:'/api/auth/users/', label:'جلب كل المستخدمين', method:'GET'},
                {url:'/api/auth/users/{userid}/', label:'تفاصيل مستخدم', method:'GET'},
                {url:'/api/auth/users/{userid}/update/', label:'تحديث مستخدم', method:'PUT'},
                {url:'/api/auth/users/{userid}/delete/', label:'حذف مستخدم', method:'DELETE'}
            ],
            'أخرى': [
                {url:'/api/recommendations/', label:'توصيات', method:'GET'},
                {url:'/api/notifications/', label:'إشعارات', method:'GET'},
                {url:'/api/user/preferences/', label:'تفضيلات المستخدم', method:'GET'},
                {url:'/api/user/', label:'المفضلات', method:'GET'},
                {url:'/api/verification/', label:'التحقق', method:'GET'},
                {url:'/api/comparison/', label:'المقارنات', method:'GET'},
                {url:'/api/dashboard/', label:'لوحة تحكم المنتجات', method:'GET'},
                {url:'/api/promotions/', label:'العروض الترويجية', method:'GET'},
                {url:'/api/reviews/', label:'المراجعات', method:'GET'}
            ]
        };
        // رسم جميع الاندبوينتات في الصفحة بشكل مسطح (بدون تقسيم أقسام)
        function renderAllEndpointsFlat() {
            const container = document.getElementById('allEndpointsFlat');
            let html = '';
            Object.keys(endpointsBySection).forEach(section => {
                endpointsBySection[section].forEach(ep => {
                    html += `<div style='display:flex;align-items:center;gap:10px;margin-bottom:7px;'><span style='font-family:monospace;background:#f7fafd;padding:4px 10px;border-radius:6px;min-width:260px;direction:ltr;'>[${ep.method}] ${ep.url}</span><span style='color:#263238;'>${ep.label} <span style='color:#1976d2;font-size:0.95em;'>(${section})</span></span><button onclick="quickTestEndpoint('${ep.url}','${ep.method}')" style='background:#1976d2;color:#fff;border:none;border-radius:6px;padding:4px 18px;cursor:pointer;'>اختبار</button></div>`;
                });
            });
            container.innerHTML = html;
        }
        document.addEventListener('DOMContentLoaded', function() {
            renderAllEndpointsFlat();
            document.getElementById('allEndpointsFlat').style.display = 'block';
        });
        // عند الضغط على زر اختبار: تعبئة الحقول تلقائياً
        function quickTestEndpoint(url, method) {
            document.getElementById('endpoint').value = url;
            document.getElementById('method').value = method;
            updateFinalUrl();
            document.getElementById('urlList').value = '';
            // تفعيل الفورم التلقائي إذا كان endpoint يحتاج body
            const event = new Event('change');
            document.getElementById('urlList').dispatchEvent(event);
            // إظهار اسم القسم
            let sectionName = '';
            Object.keys(endpointsBySection).forEach(section => {
                if(endpointsBySection[section].find(ep => ep.url === url && ep.method === method))
                    sectionName = section;
            });
            const sectionTitle = document.getElementById('sectionTitle');
            if(sectionName) {
                sectionTitle.textContent = 'القسم: ' + sectionName;
                sectionTitle.style.display = 'block';
            } else {
                sectionTitle.style.display = 'none';
            }
            window.scrollTo({top:0,behavior:'smooth'});
        }
        // إخفاء عناصر الإدخال الفردية والقائمة المنسدلة والرابط النهائي
        document.getElementById('method').style.display = 'none';
        document.getElementById('urlList').style.display = 'none';
        document.getElementById('endpoint').style.display = 'none';
        document.getElementById('finalUrl').parentElement.style.display = 'none';
        document.querySelectorAll('.param-btn').forEach(btn => btn.style.display = 'none');
        document.getElementById('body').parentElement.style.display = 'none';
        document.querySelectorAll('.endpoint-row').forEach(row => {
            if(row.querySelector('#method') || row.querySelector('#urlList') || row.querySelector('#endpoint')) row.style.display = 'none';
        });
        // إظهار زر الإرسال فقط إذا كان هناك فورم ديناميكي
        document.getElementById('dynamicForm').addEventListener('change', function() {
            const hasInputs = Array.from(this.querySelectorAll('input')).some(inp => inp.value.trim() !== '');
            const submitBtn = document.getElementById('sendRequestBtn');
            if(submitBtn) submitBtn.style.display = hasInputs ? 'inline-block' : 'none';
        });
        // إخفاء عرض الأقسام المجزأة إذا كان موجودًا
        var allEndpointsDiv = document.getElementById('allEndpoints');
        if (allEndpointsDiv) {
            allEndpointsDiv.style.display = 'none';
        }
        // إظهار جميع الاندبوينتات عند الضغط على الزر إذا لم تظهر تلقائياً
        document.getElementById('showEndpointsBtn').addEventListener('click', function() {
            renderAllEndpointsFlat();
            document.getElementById('allEndpointsFlat').style.display = 'block';
        });
    </script>
</body>
</html>
