<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</title>
    <meta name="description" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: Ø§Ø³ØªØ¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø­Ø§Ù„ØªÙ‡ØŒ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø§Ù„Ùƒ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .navbar {
            background: linear-gradient(90deg, #1976d2 0%, #0d47a1 100%);
            color: #fff;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 68px;
            box-shadow: 0 4px 18px rgba(30,60,120,0.13);
            border-radius: 0 0 18px 18px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            z-index: 100;
        }
        body { padding-top: 80px !important; }
        .navbar .brand { font-size: 1.6em; font-weight: bold; padding: 0 40px; display: flex; align-items: center; gap: 12px; letter-spacing: 1px; }
        .navbar .brand .icon { font-size: 2em; margin-left: 8px; filter: drop-shadow(0 2px 4px #0d47a1aa); }
        .navbar .menu { display: flex; align-items: center; gap: 12px; padding: 0 32px; }
        .navbar .menu button { background: rgba(255,255,255,0.13); color: #fff; border: none; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; cursor: pointer; transition: background 0.2s, transform 0.2s; box-shadow: 0 2px 8px rgba(30,60,120,0.10); }
        .navbar .menu button:hover { background: #fff; color: #1976d2; transform: translateY(-2px) scale(1.08); }
        @media (max-width: 700px) { .navbar .brand { font-size: 1.1em; padding: 0 10px; } .navbar .menu { padding: 0 8px; } }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 6px 32px rgba(30,60,120,0.10); padding: 36px 28px; }
        h2 { color: #0d47a1; text-align: center; }
        .row { display: flex; gap: 24px; margin-bottom: 18px; }
        .col { flex: 1; }
        .label { color: #1976d2; font-weight: bold; }
        .value { color: #263238; }
        .actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .actions button { background: #1976d2; color: #fff; border: none; border-radius: 6px; padding: 8px 20px; font-size: 1em; cursor: pointer; }
        .actions button.deactivate { background: #b71c1c; }
        .actions button.notify { background: #ff9800; }
        .actions button:disabled { opacity: 0.6; cursor: not-allowed; }
        .notify-form { margin-top: 18px; display: none; }
        .notify-form textarea { width: 100%; min-height: 60px; border-radius: 6px; border: 1px solid #bdbdbd; padding: 8px; font-size: 1em; }
        .notify-form button { margin-top: 8px; }
        .success { color: #388e3c; text-align: center; margin-bottom: 12px; }
        .error { color: #b71c1c; text-align: center; margin-bottom: 12px; }
    </style>
</head>
<body>
    <div class="navbar">
        <span class="brand"><span class="icon">ğŸ“¦</span> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</span>
        <div class="menu">
            <button title="Ø±Ø¬ÙˆØ¹" onclick="window.history.back()"><span>ğŸ”™</span></button>
            <button title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" onclick="window.location.href='/apps-dashboard/'"><span>ğŸ </span></button>
            <button title="Ø®Ø±ÙˆØ¬" onclick="logout()" style="background:#b71c1c;"><span>ğŸ”“</span></button>
        </div>
    </div>
    <div class="container">
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
        <div id="productDetails"></div>
        <div class="actions">
            <button id="activateBtn"></button>
            <button class="notify" onclick="showNotifyForm()">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ</button>
        </div>
        <form class="notify-form" id="notifyForm" onsubmit="return sendNotify(event)">
            <textarea id="notifyMsg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±..."></textarea>
            <button type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
        </form>
        <div id="msg"></div>
    </div>
    <script>
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');
        let product = null;
        let productStats = null;
        console.log('Product ID from URL:', productId);
        if (!productId) {
            document.getElementById('productDetails').innerHTML = '<div class="error">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!</div>';
        } else {
            async function fetchProduct(retry = true) {
                const token = localStorage.getItem('access_token');
                const res = await fetch(`/api/products/${productId}/`, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                if (res.status === 401 && retry) {
                    // Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ†
                    const refresh = localStorage.getItem('refresh_token');
                    if (refresh) {
                        const refreshRes = await fetch('/api/auth/token/refresh/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ refresh })
                        });
                        const refreshData = await refreshRes.json();
                        if (refreshRes.ok && refreshData.access) {
                            localStorage.setItem('access_token', refreshData.access);
                            return fetchProduct(false); // Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                        } else {
                            alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.');
                            window.location.href = '/static/login.html';
                            return;
                        }
                    } else {
                        alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
                        window.location.href = '/static/login.html';
                        return;
                    }
                }
                const data = await res.json();
                product = data;
                await fetchProductStats();
                renderProduct();
            }
            async function fetchProductStats() {
                const token = localStorage.getItem('access_token');
                const res = await fetch(`/api/products/${productId}/reviews-stats/`, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                productStats = await res.json();
                console.log('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬:', productStats);
            }
            fetchProduct();
        }
        function renderProduct() {
            const d = product;
            let html = `<div class='row'><div class='col'><span class='label'>Ø§Ù„Ø§Ø³Ù…:</span> <span class='value'>${d.name}</span></div><div class='col'><span class='label'>Ø§Ù„Ø³Ø¹Ø±:</span> <span class='value'>${d.price}</span></div></div>`;
            html += `<div class='row'><div class='col'><span class='label'>Ø§Ù„ÙØ¦Ø©:</span> <span class='value'>${d.category ? d.category.name : ''}</span></div><div class='col'><span class='label'>Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯:</span> <span class='value'>${d.brand ? d.brand.name : '-'}</span></div></div>`;
            html += `<div class='row'><div class='col'><span class='label'>Ø§Ù„Ù…ØªØ¬Ø±:</span> <span class='value'>${d.shop && d.shop.id ? `<a href='/static/shop_detail.html?id=${d.shop.id}' style='color:#1976d2;text-decoration:underline;cursor:pointer;'>${d.shop.name}</a>` : (d.shop ? d.shop.name : '-')}</span></div><div class='col'><span class='label'>Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…ØªØ¬Ø±:</span> <span class='value'>${d.shop && d.shop.owner_id ? `<a href='/static/user_profile.html?id=${d.shop.owner_id}' style='color:#1976d2;text-decoration:underline;cursor:pointer;'>${d.shop.owner_username}</a>` : (d.shop && d.shop.owner_username ? d.shop.owner_username : '-')}</span></div></div>`;
            html += `<div class='row'><div class='col'><span class='label'>Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span class='value' id='statusValue'>${d.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></div><div class='col'><span class='label'>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</span> <span class='value'>${d.created_at ? d.created_at.split('T')[0] : '-'}</span></div></div>`;
            html += `<div class='row'><div class='col'><span class='label'>Ø§Ù„ÙˆØµÙ:</span> <span class='value'>${d.description || '-'}</span></div></div>`;
            if(productStats) {
                html += `<div class='row'><div class='col'><span class='label'>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª:</span> <span class='value'>${productStats.likes}</span></div><div class='col'><span class='label'>Ø¹Ø¯Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨:</span> <span class='value'>${productStats.dislikes}</span></div></div>`;
                html += `<div class='row'><div class='col'><span class='label'>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙŠØ¯ÙŠÙ†:</span> <span class='value'>${productStats.neutrals}</span></div><div class='col'><span class='label'>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª:</span> <span class='value'>${productStats.views}</span></div></div>`;
                html += `<div class='row'><div class='col'><span class='label'>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙŠÙ†:</span> <span class='value'>${productStats.users_liked}</span></div><div class='col'><span class='label'>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</span> <span class='value'>${productStats.rating}</span></div></div>`;
                html += `<div class='row'><div class='col'><span class='label'>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª:</span> <span class='value'>${productStats.reviews_count}</span></div></div>`;
                html += `<div class='row'><div class='col'><span class='label'>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª:</span></div></div>`;
                if(productStats.reviews && productStats.reviews.length > 0) {
                    html += `<ul style='background:#f7fafd;padding:10px 18px;border-radius:8px;'>`;
                    productStats.reviews.forEach(r => {
                        html += `<li><b>${r.user.name}:</b> ${r.comment || ''} <span style='color:#ffb300'>â˜…${r.rating}</span></li>`;
                    });
                    html += `</ul>`;
                } else {
                    html += `<div style='color:#888'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø¨Ø¹Ø¯.</div>`;
                }
            }
            document.getElementById('productDetails').innerHTML = html;
            document.getElementById('activateBtn').textContent = d.is_active ? 'ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬' : 'ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬';
            document.getElementById('activateBtn').className = d.is_active ? 'deactivate' : '';
        }
        document.getElementById('activateBtn').onclick = async function() {
            const activate = !product.is_active;
            const token = localStorage.getItem('access_token');
            const res = await fetch(`/api/products/${product.id}/update/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ is_active: activate })
            });
            if(res.ok) {
                product.is_active = activate;
                document.getElementById('statusValue').textContent = activate ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
                renderProduct();
                showMsg('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', true);
            } else {
                showMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬', false);
            }
        };
        function showNotifyForm() {
            document.getElementById('notifyForm').style.display = 'block';
        }
        async function sendNotify(e) {
            e.preventDefault();
            const msg = document.getElementById('notifyMsg').value.trim();
            if(!msg) return showMsg('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©', false);
            const res = await fetch(`/api/dashboard/admin/products/${product.id}/notify/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            });
            if(res.ok) {
                showMsg('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­', true);
                document.getElementById('notifyForm').reset();
                document.getElementById('notifyForm').style.display = 'none';
            } else {
                showMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±', false);
            }
        }
        function showMsg(txt, success) {
            document.getElementById('msg').innerHTML = `<div class='${success ? 'success' : 'error'}'>${txt}</div>`;
            setTimeout(()=>{ document.getElementById('msg').innerHTML = '' }, 3000);
        }
    </script>
</body>
</html>
